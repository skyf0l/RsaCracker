use std::str::FromStr;

use rsacracker::{integer_to_string, run_attacks, KeyEntry, Parameters};
use rug::Integer;

#[test]
fn bluehens_ctf_2023_rsa_school_1st_grade() {
    // BlueHens CTF 2023 / RSA School 1st Grade
    // https://ctftime.org/task/26924

    let params = Parameters {
        p: Some(Integer::from_str("7009789528005665925389589645247771843738610365138497450285434114825324963561464592190523618045678504210355855286077875965585945664408796837853566415684077").unwrap()),
        n: Some(Integer::from_str("73061872549912499570368059392056653520123131891860048946474996807859190776947568485365189613739847632132597352816568237525325622321891749472819811314630053648031678826291232292672975634200777457699671848298242827252269004463672931479153540235625891818449660268924228002522141737330313259535617652381070426543").unwrap()),
        c: Some(Integer::from_str("8099012654842320180974620472267007973324910863630262955526926760464542904631823196320598910081443799605804614201671967967929893760527002416689993003801924422327762868245291561376910828637706061326005113536536357969201659290874169593264337355365186414719656091960977568710047843815328537885731546232759484717").unwrap()),
        ..Default::default()
    };

    let solution = run_attacks(&params).unwrap();
    assert!(solution.pk.is_some());
    assert_eq!(
        integer_to_string(&solution.m.unwrap()).unwrap().trim(),
        "UDCTF{y3a_b0i_b4by_RSA!}"
    );
}
// TODO: No factorization attack found: official solution is to use facordb
// #[test]
// fn bluehens_ctf_2023_rsa_school_2nd_grade() {
//     // BlueHens CTF 2023 / RSA School 2nd Grade
//     // https://ctftime.org/task/26925

//     let params = Parameters {
//         n: Some(Integer::from_str("166045890368446099470756111654736772731460671003059151938763854196360081247044441029824134260263654537").unwrap()),
//         c: Some(Integer::from_str("141927379986409920845194703499941262988061316706433242289353776802375074525295688904215113445883589653").unwrap()),
//         ..Default::default()
//     };

//     let solution = run_attacks(&params).unwrap();
//     assert!(solution.pk.is_some());
//     assert_eq!(
//         integer_to_string(&solution.m.unwrap()).unwrap().trim(),
//         "UDCTF{pr1m3_f4ct0r_the1f!}"
//     );
// }

#[test]
fn bluehens_ctf_2023_rsa_school_3rd_grade() {
    // BlueHens CTF 2023 / RSA School 3rd Grade
    // https://ctftime.org/task/26927
    // Common modulus attack with two ciphertexts encrypted with different coprime exponents

    let n = Integer::from_str("87587426608653108851564813489752475287019321764561555461700901651463446024854423042554629096780987943450742890279417241231211446818009232077230407281610183609540264821974669679932743621434901779832901512681108061652309435608446510337833028029876549629818957952682516026313018526405972829923620377438164377109").unwrap();
    let e1 = 71.into();
    let c1 = Integer::from_str("1421275848974615267320815554113040672023972283807752574007971561416386636110464890632994733734995114229161525885389065244354678964389211537085513310823751266472044865745324866096898051759507738772227296453397678055024824805366251635154522059070310922367078281343183508274450904681187384450253350434931649011").unwrap();

    let e2 = 101.into();
    let c2 = Integer::from_str("26097095086985946477598349002260598942399303275420948828501512467473619292573670218058274201990116295246084096584962695127706609264424951086000719935218496250047555039460733768633688410770610612614744411304261153778159881980276162174277085197608466835857196307432992312260307797540746411319330318058866868362").unwrap();

    let params = Parameters {
        n: Some(n.clone()),
        e: e1,
        c: Some(c1),
        keys: vec![KeyEntry {
            n: Some(n),
            e: e2,
            c: Some(c2),
        }],
        ..Default::default()
    };

    let solution = run_attacks(&params).unwrap();
    assert_eq!(
        integer_to_string(&solution.m.unwrap()).unwrap().trim(),
        "UDCTF{3uc1id_th4_60at}"
    );
}

/// Compute phi(n) from an alternative (e, d) key pair
/// Given: e_alt * d_alt â‰¡ 1 (mod phi(n))
/// Then: e_alt * d_alt - 1 = k * phi(n) for some k
/// We find k by testing divisors until we get an integer phi
fn compute_phi_from_alt_keypair(n: &Integer, e_alt: &Integer, d_alt: &Integer) -> Integer {
    let k_phi = e_alt * d_alt - Integer::from(1);
    let mut k = k_phi.clone() / n;

    // Search for the correct k where k divides (e_alt * d_alt - 1)
    for _ in 0..1_000_000 {
        if k_phi.is_divisible(&k) {
            return k_phi / &k;
        }
        k += 1;
    }

    panic!("Could not find phi within reasonable bounds");
}

#[test]
fn bluehens_ctf_2023_rsa_school_4th_grade() {
    // BlueHens CTF 2023 / RSA School 4th Grade
    // https://ctftime.org/task/26930
    //
    // This challenge provides an alternative (e, d) key pair for the same modulus.
    // We compute phi(n) from this pair, then use it to factor n via the known_phi attack.
    // Note: This requires preprocessing - rsacracker doesn't directly accept alternative
    // e/d pairs, but can solve it once phi is computed.

    let n = Integer::from_str("128923276994737790032784225847154420815473322545569053376748335367791339027988282369445542202224938698537424444443434684524386629219697192340629226569242894844874718895350330788650992608621499779776079293063355076268941953990983854217613662005027668855183281795022629934463967333582234624036115283306256019477").unwrap();
    let e = 65537.into();
    let c = Integer::from_str("101925091511033045433108849975441961999589763870098425244810307722908781911184299892072334641669931066841662878745617845011689451171244453969963211155840837507751273716371760271643490363012983256424608885239953158409708266675819028960222627654995967984657602529298637614235721996131897162063485544360691578861").unwrap();

    // Alternative keypair provided by the challenge
    let your_e = 548861.into();
    let your_d = Integer::from_str("95173232432571941329231712692828118443780574466702093807146321250099677631827067825710345421542241500117509827717221625523077656554170307232963298108032249257829668442277402436905496971410095631707035128294281318370127935482352287840967522858886054571972660826718745245567014905338023490270530223206547055189").unwrap();

    // Compute phi from the alternative keypair
    let phi = compute_phi_from_alt_keypair(&n, &your_e, &your_d);

    let params = Parameters {
        n: Some(n),
        e,
        c: Some(c),
        phi: Some(phi),
        ..Default::default()
    };

    let solution = run_attacks(&params).unwrap();
    assert!(solution.pk.is_some());
    assert_eq!(
        integer_to_string(&solution.m.unwrap()).unwrap().trim(),
        "UDCTF{m0d_mult1pl1c4tiv3_inv3r5e_nd_57uff}"
    );
}

#[test]
fn bluehens_ctf_2023_rsa_school_5th_grade() {
    // BlueHens CTF 2023 / RSA School 5th Grade
    // https://ctftime.org/task/26931

    let params = Parameters {
        n: Some(Integer::from_str("19071553514906413228005623880868413172589438760530345745552708038769515697875361787053550188848159274987925247955174211167277615747329764460652862539122337714189780686582390326881171096308885109154336023212767779863472386169665627283720649094479648444588259600544834704143105214853522264311830387911281263299214052701109619722665736303738110883886917231219876629681611411323913511707032906816948757362133848480976586951323342448069343747851239877539085111823678094070778241732994351072251605007909682674187665596109353312252881532685577047967768366217935948525094732268620589271065304471832191222326947334404799847563").unwrap()),
        c: Some(Integer::from_str("270903177796878498388304376598565799121492331770875203351555502784804760985678087802688162298096409297508110557051747972509915173895153270896299567072600809265143377905255294763705268648639628042173298874918538565864469546919085252896111245679898930789").unwrap()),
        e: 3.into(),
        ..Default::default()
    };

    let solution = run_attacks(&params).unwrap();
    assert_eq!(
        integer_to_string(&solution.m.unwrap()).unwrap().trim(),
        "UDCTF{0k_m4yb3_d0nt_u5e_e_3qu4l5_3}"
    );
}

#[test]
fn bluehens_ctf_2023_rsa_school_6th_grade() {
    // BlueHens CTF 2023 / RSA School 6th Grade
    // https://ctftime.org/task/26933
    // Hastad's broadcast attack - same message sent to 3 recipients with e=3

    let e = Integer::from(3);

    let n1 = Integer::from_str("101940404683148314092182537619741343820471969843093690407029610257328675616822058283838769182645366824344399515353353819793130816183060658423485619280610405015820030833852427722839904501250467628712096873390329778269768535928267751268139550847537802558918336829638018104196299204412108446654522040961058235837").unwrap();
    let c1 = Integer::from_str("97537343779229625148677027056474609247558991142314164186990731381686200271313205873978331513371958006472814729940790278407051941118054050488898727496970346225390695886636503944561906013129123265026309468439899500515120214095795129355317613702699593668666568316953844138511954955909885841485099479889646390930").unwrap();

    let n2 = Integer::from_str("74679681433630870500800762600180557065015193875421351446542706780716176492497162177418083881145442405798180136972926938569891311549925115691841878743075457971612412284596645067679716265041006557964732304139958791707676819596277816749996790403481863920999497042537177685582328973044036057708799002206799632839").unwrap();
    let c2 = Integer::from_str("24576278220067271066994467924629810459250013881000033163294269449098813322523936249035902376053018982711870235427255440433329932427389544039567565669233834485029769359372962513511622515998222609323796238896382805118053092524445414371375283464954274992561033256478865903093200523624090555295195503883373690124").unwrap();

    let n3 = Integer::from_str("100573737146541590945636341222262486942630621101299107026796895085532038383427686351121611043174306351150423506465657822449930435454418298186213727217811586553728175753616475183671899770943244241792060489168334224998929407994655190387844505675391919259886074847030882822522665949478946576261271617560351054403").unwrap();
    let c3 = Integer::from_str("43498624182782877233366661188600199251806006111187593264150806660094635602066978958889784097119800185861182106644332729447880775766543596889805536568073520124279816397528293711624036420976245584445797246515447058638137236091247562611424573156889579663131251891077714114495493898633857254453469780722026012280").unwrap();

    let params = Parameters {
        n: Some(n1),
        e: e.clone(),
        c: Some(c1),
        keys: vec![
            KeyEntry {
                n: Some(n2),
                e: e.clone(),
                c: Some(c2),
            },
            KeyEntry {
                n: Some(n3),
                e,
                c: Some(c3),
            },
        ],
        ..Default::default()
    };

    let solution = run_attacks(&params).unwrap();
    assert_eq!(
        integer_to_string(&solution.m.unwrap()).unwrap().trim(),
        "UDCTF{ch1n3se_r3m4ind3r_th30r3m_f0r_th4_w1n!}"
    );
}

#[test]
fn bluehens_ctf_2023_rsa_school_7th_grade() {
    // BlueHens CTF 2023 / RSA School 7th Grade
    // https://ctftime.org/task/26935

    let params = Parameters {
        n: Some(Integer::from_str("17740803753336460891508014077951088945415214329359164945595622460861617151883658129377771074141448545977293824812472806768754107334272113784618671425945265453677763300584120796664192793654787317526905676618168560287204392207536711238413377822113265783504873957094131330620182217422910507867161033695120195691266283498385072573721376398480018719760538723050237163598524153522595496137288270407836138586188296538117138982579560625325815068701431157466298638302885600982291990551448117534677697122276691651611734934147801954625280213769902451417946572231015611006746186167211313556716518863585799128114202130873384852581").unwrap()),
        c: Some(Integer::from_str("7617664236008252568996899627946125782926068188323112773389474654757630578865481085502759186904920518615173703165984894164411436709177950136929724052191922739861682189280802963747906815275683543148623167088950096943169566195634558711652670745197446307315888349532981492405588457559228674864147994684328968321710022127803384848143475788457274558988285904875669797926919759123645348144531804252200718312650929926931919262408975771593313266992606751663814830129337536342634243623652919127335934704778878412649409415730419077839365246227059700689395639431013008985996793686430486195007712091309878718060405038405039494286").unwrap()),
        ..Default::default()
    };

    let solution = run_attacks(&params).unwrap();
    assert!(solution.pk.is_some());
    assert_eq!(
        integer_to_string(&solution.m.unwrap()).unwrap().trim(),
        "UDCTF{F3rma7_c4n_sur3_fac70r!}"
    );
}

#[test]
fn bluehens_ctf_2023_rsa_school_8th_grade() {
    // BlueHens CTF 2023 / RSA School 8th Grade
    // https://ctftime.org/task/26936

    let params = Parameters {
        n: Some(Integer::from_str("150459385706485253914441877113384979120500190162060302508541299821944089329499694790524295291567135320851306118878915105907451588623958757693847782920309145753994837129247899050065917279292484317798035721308006529470560777407483024961882645653400385816416526996027114542480513056100444908809723540145733606413").unwrap()),
        c: Some(Integer::from_str("2307423154990120835718508986514267143655326830191633946685219656220840494132925634069678170936781595742873539412034460586639622885239343246714559828497111273868089182257159904851948098861145910137615097694560608874412798124055642460363270612990137075678106724613406247492210136960473648165963598137216228495").unwrap()),
        ..Default::default()
    };

    let solution = run_attacks(&params).unwrap();
    assert!(solution.pk.is_some());
    assert_eq!(
        integer_to_string(&solution.m.unwrap()).unwrap().trim(),
        "UDCTF{4n_RSA_5ch0ol_gr4dua73!!}"
    );
}
